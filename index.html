<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>RE/MAX Soul</title>

<link href="https://fonts.googleapis.com/css2?family=Questrial&display=swap" rel="stylesheet">

<style>
body{
  margin:0;
  font-family:'Questrial',sans-serif;
  background:#f2f4f8;
  display:flex;
  flex-direction:column;
  align-items:center;
}

.logo-container{text-align:center;margin-top:20px}
.balloon{width:120px}
h1{margin:6px 0}

.remax{color:#E11C2A;font-weight:bold}
.barra{color:#003A8F;font-weight:bold}
.soul{color:#003A8F;margin-left:6px}

.box{
  margin-top:12px;
  background:white;
  border-radius:16px;
  padding:20px;
  width:360px;
  box-shadow:0 4px 14px rgba(0,0,0,.12);
  border-top:6px solid #003A8F;
}

label{display:block;margin-top:12px}
input,select,textarea,button{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
  font-family:'Questrial',sans-serif;
}

button{
  margin-top:12px;
  background:#E11C2A;
  color:white;
  border:none;
  cursor:pointer;
}
button:hover{background:#003A8F}

.agenda{margin-top:18px}
.agenda li{margin-bottom:6px}
</style>
</head>
<body>

<div class="logo-container">
  <img src="balloon.png" class="balloon">
  <h1>
    <span class="remax">RE</span>
    <span class="barra">/</span>
    <span class="remax">MAX</span>
    <span class="soul">Soul</span>
  </h1>
</div>

<div class="box">
  <label>Nome</label>
  <input id="nome">

  <label>Data</label>
  <input type="date" id="data">

  <label>HorÃ¡rio</label>
  <select id="horario"></select>

  <label>Motivo</label>
  <textarea id="motivo"></textarea>

  <button onclick="agendar()">Agendar</button>
  <p id="msg"></p>

  <div class="agenda">
    <h3>Agendamentos confirmados</h3>
    <ul id="listaAgenda"></ul>
  </div>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbz5zmZDP_qsi8gu5f3QZojrltR5vSRK9yCK2TyoPFDSg_Aq-u5cBn7mybD4tsdWPOXE/exec";

const horarios=[
"07:30","08:00","08:30","09:00","09:30","10:00",
"10:30","11:00","11:30","12:00","12:30","13:00",
"13:30","14:00","14:30","15:00","15:30","16:00",
"16:30","17:00","17:30","18:00","18:30"
];

const select=document.getElementById("horario");
const dataInput=document.getElementById("data");

dataInput.addEventListener("change",carregarHorarios);

function formatarBR(iso){
  const [a,m,d]=iso.split("-");
  return `${d}/${m}/${a.slice(2)}`;
}

/* NORMALIZA DATA VINDO DA API */
function normalizarData(v){
  if(!v) return "";
  if(typeof v==="string" && v.includes("/")) return v; // jÃ¡ estÃ¡ ok
  const d=new Date(v);
  const dia=String(d.getDate()).padStart(2,"0");
  const mes=String(d.getMonth()+1).padStart(2,"0");
  const ano=String(d.getFullYear()).slice(2);
  return `${dia}/${mes}/${ano}`;
}

/* NORMALIZA HORA VINDO DA API */
function normalizarHora(v){
  if(!v) return "";
  if(typeof v==="string" && v.includes(":")) return v.slice(0,5); // "08:30"
  const d=new Date(v);
  const h=String(d.getHours()).padStart(2,"0");
  const m=String(d.getMinutes()).padStart(2,"0");
  return `${h}:${m}`;
}

async function carregarHorarios(){
  const dataISO = dataInput.value;
  if(!dataISO) return;

  const dataBR = formatarBR(dataISO);

  const res = await fetch(API_URL+"?t="+Date.now());
  const dados = await res.json();

  select.innerHTML = "";

  horarios.forEach(h=>{
    const opt = document.createElement("option");
    opt.value = h;

    const ocupado = dados.some(a => 
      normalizarData(a.data) === dataBR &&
      normalizarHora(a.hora) === h
    );

    const [horaStr, minStr] = h.split(":");
    const slotDateTime = new Date(dataISO);
    slotDateTime.setHours(parseInt(horaStr), parseInt(minStr),0,0);

    const jaPassou = slotDateTime < new Date();

    if(ocupado){
      opt.textContent = h+" (reservado)";
      opt.disabled = true;
    }else if(jaPassou){
      opt.textContent = h+" (indisponÃ­vel)";
      opt.disabled = true;
    }else{
      opt.textContent = h;
    }

    select.appendChild(opt);
  });
}

async function agendar(){
  const nome=document.getElementById("nome").value.trim();
  const motivo=document.getElementById("motivo").value.trim();
  const dataISO=dataInput.value;
  const hora=select.value;

  if(!nome||!motivo||!dataISO||!hora){
    msg("Preencha todos os campos");
    return;
  }

  const dataBR=formatarBR(dataISO);

  const formData=new URLSearchParams();
  formData.append("data",dataBR);
  formData.append("hora",hora);
  formData.append("nome",nome);
  formData.append("motivo",motivo);

  const res=await fetch(API_URL,{
    method:"POST",
    body:formData
  });

  const txt=await res.text();

  if(txt==="erro_ocupado"){
    msg("HorÃ¡rio jÃ¡ reservado");
    carregarHorarios();
    return;
  }

  msg("Agendado com sucesso âœ…");

  carregarHorarios();
  carregarAgendaPublica();
}

async function carregarAgendaPublica(){
  const res = await fetch(API_URL+"?t="+Date.now());
  const dados = await res.json();

  const ul = document.getElementById("listaAgenda");
  ul.innerHTML = "";

  dados.forEach(a=>{
    const data = normalizarData(a.data);
    const hora = normalizarHora(a.hora);

    const [dia,mes,ano]=data.split("/");
    const horaFormatada = hora.replace(":", "h");

    const li = document.createElement("li");
    li.textContent = `ðŸ“Œ ${dia}/${mes}/${ano} ${horaFormatada} â€” ${a.nome} ${a.motivo}`;
    ul.appendChild(li);
  });
}

function msg(t){
  const el=document.getElementById("msg");
  if(el) el.textContent=t;
}

window.addEventListener("DOMContentLoaded",carregarAgendaPublica);
</script>
  
</body>
</html>
