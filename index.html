<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Agendamento da Sala</title>

<style>
body{
  font-family:Arial;
  background:#f2f2f2;
  display:flex;
  justify-content:center;
  margin-top:40px;
}
.box{
  background:white;
  padding:20px;
  width:320px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
}
select,input,textarea,button{
  width:100%;
  margin:6px 0;
  padding:8px;
}

button:disabled{
  background:#e74c3c;
  color:white;
  text-decoration:line-through;
  cursor:not-allowed;
}

.reservado{
  color:#e74c3c;
  text-decoration:line-through;
}

#msg{
  margin-top:10px;
  font-weight:bold;
}
</style>
</head>

<body>
<div class="box">
<h2>Agendar Sala</h2>

<label>Nome</label>
<input id="nome">

<label>Data</label>
<input type="date" id="data">

<label>Horário</label>
<select id="horario"></select>

<label>Motivo</label>
<textarea id="motivo"></textarea>

<button id="btnAgendar" onclick="agendar()">Agendar</button>

<p id="msg"></p>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbxhiRqpoBienFmCKNOdEt0tXsuwNGPcjWS05rieQE01sU8zmSgV99jGXY0Ef63-JKDoQA/exec";

const horarios=Array.from({length:24},(_,h)=>String(h).padStart(2,"0")+":00");

let agendaGlobal=[];

const select=document.getElementById("horario");
const dataInput=document.getElementById("data");
const btn=document.getElementById("btnAgendar");

dataInput.addEventListener("change", carregarHorarios);
select.addEventListener("change", verificarSelecionado);

function formatarDataPlanilha(v){
  if(!v) return "";
  return new Date(v).toISOString().slice(0,10);
}

function formatarHoraPlanilha(v){
  if(!v) return "";
  const d=new Date(v);
  return String(d.getHours()).padStart(2,"0")+":00";
}

async function carregarHorarios(){
  const data=dataInput.value;
  select.innerHTML="";
  btn.disabled=true;

  if(!data) return;

  try{
    const res=await fetch(API_URL+"?t="+Date.now());
    const dados=await res.json();

    agendaGlobal=dados.map(l=>({
      data:formatarDataPlanilha(l[1]),
      hora:formatarHoraPlanilha(l[2])
    }));

    horarios.forEach(h=>{
      const ocupado=agendaGlobal.some(a=>a.data===data && a.hora===h);

      const opt=document.createElement("option");
      opt.value=h;

      if(ocupado){
        opt.textContent=h+" (reservada)";
        opt.classList.add("reservado");
        opt.dataset.ocupado="1";
      }else{
        opt.textContent=h;
      }

      select.appendChild(opt);
    });

    btn.disabled=false;

  }catch(e){
    msg("Erro ao carregar agenda");
    console.error(e);
  }
}

function verificarSelecionado(){
  const opt=select.selectedOptions[0];
  if(!opt) return;

  if(opt.dataset.ocupado==="1"){
    btn.disabled=true;
  }else{
    btn.disabled=false;
  }
}

async function agendar(){
  const nome=document.getElementById("nome").value.trim();
  const data=dataInput.value;
  const hora=select.value;
  const motivo=document.getElementById("motivo").value.trim();

  if(!nome||!data||!hora||!motivo){
    msg("Preencha todos os campos");
    return;
  }

  try{
    const res=await fetch(API_URL,{
      method:"POST",
      body:JSON.stringify({nome,data,hora,motivo})
    });

    const txt=await res.text();

    if(txt==="ocupado"){
      msg("Horário já reservado");
      carregarHorarios();
      return;
    }

    msg("Agendado ✔️");
    carregarHorarios();

  }catch(e){
    msg("Erro ao agendar");
    console.error(e);
  }
}

function msg(t){
  document.getElementById("msg").textContent=t;
}
</script>
</body>
</html>
