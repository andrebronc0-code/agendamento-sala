<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>RE/MAX Soul</title>
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Questrial&display=swap" rel="stylesheet">
</head>
<body>
  <div class="logo-container">
    <img src="balloon.png" alt="Balão RE/MAX" class="balloon">
    <h1>
      <span class="remax">RE</span>
      <span class="barra">/</span>
      <span class="remax">MAX</span>
      <span class="soul">Soul</span>
    </h1>
  </div>

  <div class="box">
    <h2>Agendamento - Base Soul</h2>
    <p>Bem-vindo ao sistema de agendamento da sala!</p>

    <label>Nome</label>
    <input id="nome">

    <label>Data</label>
    <input type="date" id="data">

    <label>Horário</label>
    <select id="horario"></select>

    <label>Motivo</label>
    <textarea id="motivo"></textarea>

    <button onclick="agendar()">Agendar</button>
    <p id="msg"></p>
    
    <div class="agenda">
      <h3>Agendamentos confirmados</h3>
      <ul id="listaAgenda"></ul>
    </div>
  </div>

  <script>
    const API_URL="https://script.google.com/macros/s/AKfycbxcfEqcLqu9fIuPBukjEpI4vmqGuJh17nyHH1DlloNdJ35NodWqzdfj8eQQCvcVp0Zu/exec";

    const horarios=Array.from({length:24},(_,h)=>String(h).padStart(2,"0")+":00");
    const select=document.getElementById("horario");
    const dataInput=document.getElementById("data");

    dataInput.addEventListener("change", carregarHorarios);

    // Formata data no padrão brasileiro dd/mm/aa
    function formatarDataPlanilha(v){
      if(!v) return "";
      const d = new Date(v);
      const dia = String(d.getDate()).padStart(2,"0");
      const mes = String(d.getMonth()+1).padStart(2,"0");
      const ano = String(d.getFullYear()).slice(-2);
      return `${dia}/${mes}/${ano}`;
    }

    // Formata hora
  function formatarHoraPlanilha(v){
  if(!v) return "";
  
  // Se já vier como texto "HH:MM", retorna só os 5 primeiros caracteres
  if (typeof v === "string") {
    return v.slice(0,5);
  }

  // Se vier como Date, extrai hora e minuto
  const d = new Date(v);
  const hora = String(d.getHours()).padStart(2,"0");
  const minuto = String(d.getMinutes()).padStart(2,"0");
  return `${hora}:${minuto}`;
}


    async function carregarHorarios(){
      const data=dataInput.value;
      select.innerHTML="";
      if(!data) return;
      try{
        const res=await fetch(API_URL+"?t="+Date.now());
        const dados=await res.json();
        const agenda=dados.map(l=>({ data:l[1], hora:l[2] })); // mantém como texto para comparação
        horarios.forEach(h=>{
          const opt=document.createElement("option");
          opt.value=h;
          const ocupado=agenda.some(a=>a.data===data && a.hora===h);
          if(ocupado){
            opt.textContent=h+" (reservada)";
            opt.disabled=true;
          }else{
            opt.textContent=h;
          }
          select.appendChild(opt);
        });
      }catch(e){
        msg("Erro ao carregar agenda");
        console.error(e);
      }
    }

    async function agendar(){
      const nome=document.getElementById("nome").value.trim();
      const data=dataInput.value;
      const hora=select.value;
      const motivo=document.getElementById("motivo").value.trim();
      if(!nome||!data||!hora||!motivo){
        msg("Preencha todos os campos");
        return;
      }
      if(select.selectedOptions[0].disabled){
        msg("Horário já reservado");
        return;
      }
      try{
        const res=await fetch(API_URL,{
          method:"POST",
          body:JSON.stringify({nome,data,hora,motivo})
        });
        const txt=await res.text();
        if(txt==="ocupado"){
          msg("Horário já reservado");
          carregarHorarios();
          carregarAgendaPublica();
          return;
        }
        msg("Agendado ✔️");
        carregarHorarios();
        carregarAgendaPublica();
      }catch(e){
        msg("Erro ao agendar");
        console.error(e);
      }
    }

    async function carregarAgendaPublica() {
      try {
        const res = await fetch(API_URL+"?t="+Date.now());
        const dados = await res.json();

        const listaAgenda = document.getElementById("listaAgenda");
        listaAgenda.innerHTML = "";

        dados.forEach(l => {
          const nome = l[0];
          const dataLinha = formatarDataPlanilha(l[1]);
          const horaLinha = formatarHoraPlanilha(l[2]);
          const motivo = l[3];

          const li = document.createElement("li");
          li.textContent = ` ${dataLinha} ${horaLinha} - ${nome} <em>${motivo}<em>`;
          listaAgenda.appendChild(li);
        });
      } catch(e) {
        msg("Erro ao carregar agenda pública");
        console.error(e);
      }
    }

    function msg(t){
      document.getElementById("msg").textContent=t;
    }

    window.addEventListener("DOMContentLoaded", carregarAgendaPublica);
  </script>
</body>
</html>
