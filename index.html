<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Agenda RE/MAX</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="box">

  <img src="balao.png" class="logo">

  <div class="marca">
    <span class="remax">RE/MAX</span>
    <span class="soul">/Soul</span>
  </div>

  <label>Data</label>
  <input type="date" id="data">

  <label>HorÃ¡rio</label>
  <div id="slots"></div>

  <label>Nome</label>
  <input type="text" id="nome">

  <label>Motivo</label>
  <input type="text" id="motivo" maxlength="120">

  <button onclick="agendar()">Agendar</button>

  <div id="msg"></div>

</div>

<div class="agendaBox">
  <h3>Agendamentos confirmados</h3>
  <ul id="agenda"></ul>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbzCOiEMSdQ8lkIOQaxVt6lrrJ6fDQFdIDaydBKZf2hg7pRzVRvtZdpUoFPYnetNH3tI/exec";

const HORARIOS = [
"07:30","08:00","08:30","09:00","09:30","10:00",
"10:30","11:00","11:30","12:00","12:30","13:00",
"13:30","14:00","14:30","15:00","15:30","16:00",
"16:30","17:00","17:30","18:00","18:30"
];

let selecionado=null;

document.getElementById("data").addEventListener("change", carregarSlots);

function formatarDataBR(dataISO){
  const [a,m,d]=dataISO.split("-");
  return `${d}/${m}/${a.slice(2)}`;
}

{
  const dataISO = document.getElementById("data").value;
  if(!dataISO) return;

  const dataBR = formatarDataBR(dataISO);

  let agenda=[];
  try{
    const res = await fetch(API_URL+"?t="+Date.now());
    agenda = await res.json();
  }catch(e){
    console.error("Erro API:",e);
  }

  const ocupados = agenda
    .filter(a=>a.data===dataBR)
    .map(a=>a.hora);

  const div = document.getElementById("slots");
  div.innerHTML="";
  selecionado=null;

  HORARIOS.forEach(h=>{
    const b=document.createElement("div");
    b.className="slot";
    b.textContent=h;

    if(ocupados.includes(h)){
      b.classList.add("ocupado");
      b.title="jÃ¡ reservado";
    }else{
      b.onclick=()=>selecionar(b,h);
    }

    div.appendChild(b);
  });
}
  const dataBR = formatarDataBR(dataISO);

  const res = await fetch(API_URL+"?t="+Date.now());
  const agenda = await res.json();

  const ocupados = agenda
    .filter(a=>a.data===dataBR)
    .map(a=>a.hora);

  const div = document.getElementById("slots");
  div.innerHTML="";
  selecionado=null;

  HORARIOS.forEach(h=>{
    const b=document.createElement("div");
    b.className="slot";
    b.textContent=h;

    if(ocupados.includes(h)){
      b.classList.add("ocupado");
      b.title="jÃ¡ reservado";
    }else{
      b.onclick=()=>selecionar(b,h);
    }

    div.appendChild(b);
  });
}

function selecionar(el,h){
  document.querySelectorAll(".slot").forEach(s=>s.classList.remove("sel"));
  el.classList.add("sel");
  selecionado=h;
}

async function agendar(){
  const nome=document.getElementById("nome").value.trim();
  const motivo=document.getElementById("motivo").value.trim();
  const dataISO=document.getElementById("data").value;

  if(!nome||!motivo||!dataISO||!selecionado){
    msg("Preencha todos os campos");
    return;
  }

  const dataBR=formatarDataBR(dataISO);

  const res=await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      data:dataBR,
      hora:selecionado,
      nome,
      motivo
    })
  });

  const txt=await res.text();

  if(txt==="erro_ocupado") return msg("HorÃ¡rio jÃ¡ reservado");
  if(txt==="erro_passado") return msg("NÃ£o Ã© possÃ­vel horÃ¡rio passado");
  if(txt==="erro_campos") return msg("Preencha todos os campos");

  msg("Agendado com sucesso âœ…");

  document.getElementById("data").value="";
  document.getElementById("nome").value="";
  document.getElementById("motivo").value="";
  document.getElementById("slots").innerHTML="";
  carregarAgenda();
}

async function carregarAgenda(){
  const res=await fetch(API_URL+"?t="+Date.now());
  const dados=await res.json();

  dados.sort((a,b)=>{
    const da=parseData(a);
    const db=parseData(b);
    return da-db;
  });

  const ul=document.getElementById("agenda");
  ul.innerHTML="";

  dados.forEach(a=>{
    const li=document.createElement("li");
    li.innerHTML=`ðŸ“Œ ${a.nome} â†’ ${a.data} ${a.hora} <em>${a.motivo}</em>`;
    ul.appendChild(li);
  });
}

function parseData(a){
  const [d,m,y]=a.data.split("/");
  const [h,min]=a.hora.split(":");
  return new Date("20"+y,m-1,d,h,min);
}

function msg(t){
  document.getElementById("msg").textContent=t;
}

carregarAgenda();
</script>

</body>
</html>
