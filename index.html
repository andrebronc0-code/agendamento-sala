<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Agendamento da Sala</title>

<style>
body{
  font-family:Arial;
  background:#f2f2f2;
  display:flex;
  justify-content:center;
  margin-top:40px;
}
.box{
  background:white;
  padding:20px;
  width:320px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.15);
}
select,input,textarea,button{
  width:100%;
  margin:6px 0;
  padding:8px;
}
#msg{
  margin-top:10px;
  font-weight:bold;
}
option:disabled{
  color:#999;
}
</style>
</head>

<body>
<div class="box">
<h2>Agendar Sala</h2>

<label>Nome</label>
<input id="nome" required>

<label>Data</label>
<input type="date" id="data" required>

<label>Horário</label>
<select id="horario"></select>

<label>Motivo</label>
<textarea id="motivo" required></textarea>

<button onclick="agendar()">Agendar</button>

<p id="msg"></p>
</div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbyjlZG2ki-xdK5fS4AXgsyrzvEaob4C7-0ej1ZceE4ocEt-EtHuUFKwOR8BV11LcPcFug/exec";

const horarios=Array.from({length:24},(_,h)=> String(h).padStart(2,"0")+":00");

let agendaGlobal=[];

const select=document.getElementById("horario");
const dataInput=document.getElementById("data");

dataInput.addEventListener("change", carregarHorarios);

function formatarDataPlanilha(valor){
  if(!valor) return "";
  const d=new Date(valor);
  return d.toISOString().slice(0,10);
}

function formatarHoraPlanilha(valor){
  if(!valor) return "";
  const d=new Date(valor);
  return String(d.getHours()).padStart(2,"0")+":00";
}

async function carregarHorarios(){
  const data=dataInput.value;
  select.innerHTML="";

  if(!data) return;

  try{
    const res=await fetch(API_URL+"?nocache="+Date.now());
    const dados=await res.json();

    agendaGlobal=dados.map(l=>({
      nome:l[0],
      data:formatarDataPlanilha(l[1]),
      hora:formatarHoraPlanilha(l[2]),
      motivo:l[3]
    }));

    horarios.forEach(h=>{
      const opt=document.createElement("option");
      opt.value=h;

      const ocupado=agendaGlobal.some(a=>a.data===data && a.hora===h);

      if(ocupado){
        opt.textContent=h+" (ocupado)";
        opt.disabled=true;
      }else{
        opt.textContent=h;
      }

      select.appendChild(opt);
    });

  }catch(e){
    msg("Erro ao carregar agenda");
    console.error(e);
  }
}

async function agendar(){
  const nome=document.getElementById("nome").value.trim();
  const data=dataInput.value;
  const hora=select.value;
  const motivo=document.getElementById("motivo").value.trim();

  if(!nome||!data||!hora||!motivo){
    msg("Preencha todos os campos");
    return;
  }

  try{
    const res=await fetch(API_URL,{
      method:"POST",
      body:JSON.stringify({nome,data,hora,motivo})
    });

    const txt=await res.text();

    if(txt==="ocupado"){
      msg("Horário já reservado");
      carregarHorarios();
      return;
    }

    msg("Agendado ✔️");
    carregarHorarios();

  }catch(e){
    msg("Erro ao agendar");
    console.error(e);
  }
}

function msg(t){
  document.getElementById("msg").textContent=t;
}
</script>
</body>
</html>
